-- ğŸ‡ AutoFarm PRO FIX - KhÃ´ng nháº·t nháº§m cÃ¢y, nháº·t dÃ­nh sÃ¡t, bÃ¡n "Sell All"

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local workspace = workspace

local SCAN_INTERVAL = 0.1
local SELL_COORDS = Vector3.new(-59, 5, 152)
local rarityRank = {
	Common = 1, Uncommon = 2, Rare = 3,
	Epic = 4, Legendary = 5, Mythic = 6, Unique = 7
}

local fruitKeywords = {"fruit","apple","pear","orange","banana","berry","mango","melon","bomb"}
local blacklist = {"tree","plant","sapling","visual","particle","effect","mesh","model","gui","hitbox","trail","spark"}

-- ğŸ§± GUI
local gui = Instance.new("ScreenGui")
gui.Name = "AutoFarmGUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0,180,0,90)
frame.Position = UDim2.new(0.5,90,0.5,-45)
frame.BackgroundColor3 = Color3.fromRGB(35,35,35)
frame.Active = true
frame.Draggable = true
frame.BorderSizePixel = 0
frame.BackgroundTransparency = 0.1
frame.Parent = gui

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1,-10,0,24)
title.Position = UDim2.new(0,5,0,4)
title.BackgroundTransparency = 1
title.Text = "ğŸ‡ Auto Farm PRO"
title.TextColor3 = Color3.new(1,1,1)
title.TextScaled = true
title.Font = Enum.Font.SourceSansBold
title.Parent = frame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(1,-10,0,28)
toggleBtn.Position = UDim2.new(0,5,0,28)
toggleBtn.Text = "ğŸ”„ OFF"
toggleBtn.TextScaled = true
toggleBtn.Font = Enum.Font.SourceSansSemibold
toggleBtn.BackgroundColor3 = Color3.fromRGB(90,90,90)
toggleBtn.TextColor3 = Color3.fromRGB(255,255,255)
toggleBtn.Parent = frame

local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1,-10,0,24)
statusLabel.Position = UDim2.new(0,5,0,60)
statusLabel.BackgroundTransparency = 1
statusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
statusLabel.TextScaled = true
statusLabel.Font = Enum.Font.SourceSansItalic
statusLabel.Text = "â¸ï¸ Äang chá» báº­t..."
statusLabel.Parent = frame

local function setStatus(text, color)
	statusLabel.Text = text
	statusLabel.TextColor3 = color
end

-- ğŸŸ¢ Báº­t/táº¯t
local enabled = false
toggleBtn.MouseButton1Click:Connect(function()
	enabled = not enabled
	if enabled then
		toggleBtn.Text = "âœ… ON"
		toggleBtn.BackgroundColor3 = Color3.fromRGB(50,150,50)
		setStatus("ğŸ” Äang tÃ¬m trÃ¡i...", Color3.fromRGB(255,255,0))
	else
		toggleBtn.Text = "ğŸ”„ OFF"
		toggleBtn.BackgroundColor3 = Color3.fromRGB(90,90,90)
		setStatus("â¸ï¸ Äang táº¯t...", Color3.fromRGB(200,200,200))
	end
end)

-- ğŸ§© Helper
local function strtolower(s) return tostring(s):lower() end

local function hasPrompt(obj)
	for _, d in ipairs(obj:GetDescendants()) do
		if d:IsA("ProximityPrompt") then return true end
	end
	return false
end

local function isFruitObject(obj)
	local n = strtolower(obj.Name)
	local ok = false
	for _, kw in ipairs(fruitKeywords) do
		if n:find(kw) then ok = true break end
	end
	if not ok then return false end
	for _, bad in ipairs(blacklist) do
		if n:find(bad) then return false end
	end
	return hasPrompt(obj)
end

local function getRarity(obj)
	for rName, _ in pairs(rarityRank) do
		if tostring(obj.Name):lower():find(rName:lower()) then
			return rName
		end
	end
	return "Unknown"
end

local function rarityValue(r)
	return rarityRank[r] or 0
end

local function safeGetPosition(inst)
	if inst:IsA("BasePart") then return inst.Position end
	local part = inst:FindFirstChildWhichIsA("BasePart", true)
	if part then return part.Position end
	return nil
end

local function getPrompt(obj)
	for _, d in ipairs(obj:GetDescendants()) do
		if d:IsA("ProximityPrompt") then return d end
	end
end

local function triggerPromptOnce(prompt)
	if not prompt or not prompt:IsA("ProximityPrompt") then return end
	pcall(function()
		fireproximityprompt(prompt)
	end)
end

local function findInventory()
	for _, guiObj in ipairs(player.PlayerGui:GetDescendants()) do
		if guiObj:IsA("TextLabel") then
			if string.match(guiObj.Text, "(%d+)%s*/%s*(%d+)") then
				return guiObj
			end
		end
	end
end

local function parseInventoryText(txt)
	if not txt then return 0, 2 end
	local a,b = string.match(txt, "(%d+)%s*/%s*(%d+)")
	if a and b then return tonumber(a), tonumber(b) end
	return 0, 2
end

-- âš¡ AutoFarm loop (Ä‘Ã£ tÃ­ch há»£p cÆ¡ cháº¿ "Sell All" an toÃ n nháº¥t)
task.spawn(function()
	while true do
		task.wait(SCAN_INTERVAL)
		if enabled then
			local label = findInventory()
			local cur, max = 0, 2
			if label then
				cur, max = parseInventoryText(label.Text)
			end

			-- Náº¿u Ä‘áº§y -> TP vá» vÃ  kÃ­ch hoáº¡t Sell All (ráº¥t an toÃ n)
			if cur >= max then
				setStatus("ğŸ’° BÃ¡n táº¥t cáº£...", Color3.fromRGB(0,255,0))
				pcall(function()
					if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
						player.Character.HumanoidRootPart.CFrame = CFrame.new(SELL_COORDS)
					end
				end)
				task.wait(0.35)

				-- TÃ¬m prompt "sell all" Æ°u tiÃªn: kiá»ƒm tra Name, ActionText, ObjectText
				local foundPrompt = nil
				local sellPrompts = {}

				for _, p in ipairs(workspace:GetDescendants()) do
					if p:IsA("ProximityPrompt") then
						local name = tostring(p.Name):lower()
						local act = tostring(p.ActionText or ""):lower()
						local obj = tostring(p.ObjectText or ""):lower()

						-- Æ¯u tiÃªn "sell all"
						if name:find("sell all") or act:find("sell all") or obj:find("sell all") then
							foundPrompt = p
							break
						end

						-- LÆ°u cÃ¡c prompt cÃ³ "sell" Ä‘á»ƒ fallback
						if name:find("sell") or act:find("sell") or obj:find("sell") then
							table.insert(sellPrompts, p)
						end
					end
				end

				-- Náº¿u tÃ¬m tháº¥y "sell all" -> kÃ­ch hoáº¡t 1 láº§n
				if foundPrompt then
					pcall(function() fireproximityprompt(foundPrompt) end)
				else
					-- Náº¿u khÃ´ng, thá»­ láº§n lÆ°á»£t cÃ¡c prompt "sell" (báº¥m táº¥t cáº£ Ä‘á»ƒ cháº¯c cháº¯n)
					for _, p in ipairs(sellPrompts) do
						pcall(function()
							fireproximityprompt(p)
						end)
						task.wait(0.12)
					end
				end

				task.wait(0.3)
				setStatus("ğŸ” Äang tÃ¬m trÃ¡i...", Color3.fromRGB(255,255,0))

			else
				-- TÃ¬m trÃ¡i rá»¥ng tháº­t (lá»c cÃ¢y ngÆ°á»i chÆ¡i)
				local fruits = {}
				for _, obj in ipairs(workspace:GetChildren()) do
					if isFruitObject(obj) and not tostring(obj.Name):lower():find("tree") then
						local pos = safeGetPosition(obj)
						if pos then
							local rarity = getRarity(obj)
							table.insert(fruits, {
								instance = obj,
								rarity = rarity,
								rank = rarityValue(rarity),
								pos = pos
							})
						end
					end
				end

				-- Sáº¯p xáº¿p theo Ä‘á»™ hiáº¿m
				table.sort(fruits, function(a, b) return a.rank > b.rank end)
				local target = fruits[1]

				if target then
					setStatus("ğŸ Nháº·t "..(target.rarity or "Unknown").."...", Color3.fromRGB(100,200,255))
					local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")

					if hrp and target.pos then
						pcall(function()
							-- DÃ­nh sÃ¡t vÃ o trÃ¡i (Ä‘áº·t tháº¥p hÆ¡n Ä‘á»ƒ prompt dá»… detect)
							hrp.CFrame = CFrame.new(target.pos + Vector3.new(0, 1.2, 0))
						end)

						-- DÃ­nh liÃªn tá»¥c cho tá»›i khi nháº·t Ä‘Æ°á»£c (siÃªu nhanh)
                           local timeout = tick() + 1.5
                           while target.instance and target.instance.Parent and tick() < timeout do
	                           local prompt = getPrompt(target.instance)
                               if not prompt then break end -- náº¿u prompt biáº¿n máº¥t (Ä‘Ã£ nháº·t xong) thÃ¬ dá»«ng ngay
	                           pcall(function() fireproximityprompt(prompt) end)
	                           task.wait(0.03) -- tÄƒng tá»‘c nháº·t nhanh hÆ¡n
                            end
					end
				else
					setStatus("ğŸ” KhÃ´ng tháº¥y trÃ¡i...", Color3.fromRGB(255,255,0))
				end
			end
		end
	end
end)
