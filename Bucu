-- AutoFarm LocalScript (phi√™n b·∫£n ƒë√£ fix l·ªói, TP ngay l·∫≠p t·ª©c, an to√†n khi h·ª•t item)
-- D√°n v√†o StarterPlayerScripts ho·∫∑c PlayerGui (LocalScript)
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local workspace = workspace

-- C·∫•u h√¨nh
local SCAN_INTERVAL = 0.1
local PICK_WAIT_AFTER_TRIGGER = 0.8
local SELL_WAIT_AFTER_TRIGGER = 1.2
local SELL_COORDS = Vector3.new(-59, 5, 152)
local MAX_RESULTS = 200

local rarityRank = {
    Common = 1, Uncommon = 2, Rare = 3,
    Epic = 4, Legendary = 5, Mythic = 6, Unique = 7
}

local fruitKeywords = {"fruit","apple","pear","orange","banana","berry","mango","melon","bomb"}
local blacklist = {"visual","particle","effect","mesh","model","gui","hitbox","trail","spark"}

-- GUI AutoFarm toggle (gi·ªØ nguy√™n giao di·ªán)
local gui = Instance.new("ScreenGui")
gui.Name = "AutoFarmGUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0,180,0,60)
frame.Position = UDim2.new(0.5,-90,0.85,0)
frame.BackgroundColor3 = Color3.fromRGB(35,35,35)
frame.Active = true
frame.Draggable = true

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,-10,0,24)
title.Position = UDim2.new(0,5,0,4)
title.BackgroundTransparency = 1
title.Text = "Auto Farm"
title.TextColor3 = Color3.new(1,1,1)
title.TextScaled = true
title.Font = Enum.Font.SourceSansBold

local toggleBtn = Instance.new("TextButton", frame)
toggleBtn.Size = UDim2.new(1,-10,0,30)
toggleBtn.Position = UDim2.new(0,5,0,28)
toggleBtn.Text = "üîÑ OFF"
toggleBtn.TextScaled = true
toggleBtn.Font = Enum.Font.SourceSansSemibold
toggleBtn.BackgroundColor3 = Color3.fromRGB(90,90,90)
toggleBtn.TextColor3 = Color3.fromRGB(255,255,255)

local enabled = false
toggleBtn.MouseButton1Click:Connect(function()
    enabled = not enabled
    if enabled then
        toggleBtn.Text = "‚úÖ ON"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(50,150,50)
    else
        toggleBtn.Text = "üîÑ OFF"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(90,90,90)
    end
end)

-- Helpers
local function strtolower(s) return tostring(s):lower() end

local function isFruitObject(obj)
    local n = strtolower(obj.Name)
    local ok = false
    for _, kw in ipairs(fruitKeywords) do
        if n:find(kw) then ok = true; break end
    end
    if not ok then return false end
    for _, bad in ipairs(blacklist) do
        if n:find(bad) then return false end
    end
    return true
end

local function getRarity(obj)
    local lower = strtolower(obj.Name)
    for rName, _ in pairs(rarityRank) do
        if lower:find(strlower and string.lower(rName) or rName:lower()) then
            return rName
        end
    end
    if obj:GetAttribute and obj:GetAttribute("Rarity") then
        return tostring(obj:GetAttribute("Rarity"))
    end
    local c = obj:FindFirstChild("Rarity")
    if c then
        if c:IsA("StringValue") or c:IsA("IntValue") or c:IsA("ValueBase") then
            return tostring(c.Value)
        end
    end
    return "Unknown"
end

local function rarityValue(r)
    if r and rarityRank[r] then return rarityRank[r] end
    return 0
end

local function findProximityPrompt(obj)
    for _, d in ipairs(obj:GetDescendants()) do
        if d:IsA("ProximityPrompt") then return d end
    end
    local parent = obj.Parent
    if parent then
        for _, d in ipairs(parent:GetDescendants()) do
            if d:IsA("ProximityPrompt") then return d end
        end
    end
    return nil
end

-- Safe trigger: th·ª≠ InputHoldBegin/End, Trigger, ho·∫∑c t√¨m RemoteEvent b√™n c·∫°nh prompt
local function safeTriggerPrompt(prompt)
    if not prompt or not prompt:IsA("ProximityPrompt") then return false end
    if prompt.Enabled == false then return false end
    local ok = false
    -- Try InputHoldBegin/End if present
    ok = pcall(function()
        -- Some environments: InputHoldBegin may not be callable, wrap in pcall
        if pcall(function() prompt:InputHoldBegin() end) then
            task.wait(0.25)
            pcall(function() prompt:InputHoldEnd() end)
            return
        end
        -- fallback: try :Trigger() or :Fire() style
        if pcall(function() prompt:Trigger() end) then return end
    end)
    if ok then return true end
    -- last resort: search for RemoteEvent/RemoteFunction siblings and FireServer
    local par = prompt.Parent
    if par then
        for _, c in ipairs(par:GetChildren()) do
            if c:IsA("RemoteEvent") then
                pcall(function() c:FireServer() end)
                return true
            elseif c:IsA("RemoteFunction") then
                pcall(function() c:InvokeServer() end)
                return true
            end
        end
    end
    return false
end

local function safeGetPosition(inst)
    if not inst then return nil end
    if inst:IsA("BasePart") then
        return inst.Position
    end
    if not inst:IsDescendantOf(workspace) and not inst:IsDescendantOf(game.ReplicatedStorage) then
        return nil
    end
    local part = inst:FindFirstChildWhichIsA("BasePart", true)
    if part then return part.Position end
    return nil
end

local function findBackpackLabel()
    if not player.Character then return nil end
    for _, obj in ipairs(player.Character:GetDescendants()) do
        if obj:IsA("TextLabel") or obj:IsA("TextButton") then
            if tostring(obj.Text):find("%d+%s*/%s*%d+") then
                return obj
            end
        elseif obj:IsA("BillboardGui") then
            local tl = obj:FindFirstChildWhichIsA("TextLabel", true)
            if tl and tostring(tl.Text):find("%d+%s*/%s*%d+") then
                return tl
            end
        end
    end
    return nil
end

local function parseInventoryText(txt)
    if not txt then return nil end
    local a,b = string.match(tostring(txt), "(%d+)%s*/%s*(%d+)")
    if a and b then
        return tonumber(a), tonumber(b)
    end
    return nil
end

-- Scan fruits in Workspace + ReplicatedStorage
local function scanFruits()
    local found = {}
    local checked = 0
    local containers = {workspace, game:GetService("ReplicatedStorage")}
    for _, cont in ipairs(containers) do
        for _, obj in ipairs(cont:GetDescendants()) do
            if checked >= MAX_RESULTS then break end
            if isFruitObject(obj) then
                checked = checked + 1
                local r = getRarity(obj)
                local val = rarityValue(r)
                local pos = safeGetPosition(obj)
                table.insert(found, {instance = obj, rarity = r, rank = val, pos = pos})
            end
        end
        if checked >= MAX_RESULTS then break end
    end
    return found
end

local function pickBestAndSmallest(list)
    if #list == 0 then return nil, nil end
    table.sort(list, function(a,b)
        if a.rank == b.rank then
            return a.instance.Name < b.instance.Name
        end
        return a.rank > b.rank -- bigger rank = rarer = earlier
    end)
    local best = list[1]
    local smallest = list[#list]
    return best, smallest
end

-- Handle picking an item safely. Return true on likely success.
local function handlePickFor(item)
    if not item or not item.instance then return false end
    -- ensure item still exists in Workspace/ReplicatedStorage
    if not item.instance:IsDescendantOf(workspace) and not item.instance:IsDescendantOf(game:GetService("ReplicatedStorage")) then
        -- gone
        return false
    end
    local pos = safeGetPosition(item.instance)
    if not pos then
        return false
    end
    -- teleport immediately (CFrame)
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    pcall(function() hrp.CFrame = CFrame.new(pos + Vector3.new(0,3,0)) end)
    task.wait(0.08)
    -- re-check existence
    if not item.instance or not item.instance:IsDescendantOf(workspace) then
        return false
    end
    -- find prompt
    local prompt = findProximityPrompt(item.instance)
    if not prompt then
        -- fallback find prompt near pos within 6 studs
        for _, p in ipairs(workspace:GetDescendants()) do
            if p:IsA("ProximityPrompt") then
                local parentPart = p.Parent
                local ppos
                if parentPart and parentPart:IsA("BasePart") then ppos = parentPart.Position end
                if ppos and pos and (ppos - pos).Magnitude <= 6 then
                    prompt = p
                    break
                end
            end
        end
    end
    if not prompt then
        return false
    end
    local ok = safeTriggerPrompt(prompt)
    if not ok then
        return false
    end
    task.wait(PICK_WAIT_AFTER_TRIGGER)
    -- if instance removed -> likely picked
    if not item.instance or not item.instance:IsDescendantOf(workspace) then
        return true
    end
    -- otherwise consider it failed
    return false
end

-- Core loop
local running = true
spawn(function()
    while running do
        ::continue::
        task.wait(SCAN_INTERVAL)
        if not enabled then
            goto continue
        end

        if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
            goto continue
        end

        -- inventory check
        local invLabel = findBackpackLabel()
        local cur, max = nil, nil
        if invLabel then
            cur, max = parseInventoryText(invLabel.Text)
        end

        if cur and max and cur >= max then
            -- go sell
            pcall(function() player.Character.HumanoidRootPart.CFrame = CFrame.new(SELL_COORDS) end)
            task.wait(0.4)
            -- find sell prompt
            local sellPrompt = nil
            for _, p in ipairs(workspace:GetDescendants()) do
                if p:IsA("ProximityPrompt") then
                    local pname = tostring(p.Name):lower()
                    if pname:find("sell") or tostring(p.Action):lower():find("sell") then
                        sellPrompt = p
                        break
                    end
                end
            end
            if sellPrompt then
                pcall(function() safeTriggerPrompt(sellPrompt) end)
                task.wait(SELL_WAIT_AFTER_TRIGGER)
            else
                -- kh√¥ng t√¨m th·∫•y sell prompt, ch·ªù v√† ti·∫øp t·ª•c
                task.wait(1)
            end
            goto continue
        end

        -- scan v√† ch·ªçn target
        local fruits = scanFruits()
        if #fruits == 0 then
            goto continue
        end

        local best, smallest = pickBestAndSmallest(fruits)
        if not best then goto continue end

        -- try pick best
        local picked = false
        local ok, err = pcall(function()
            picked = handlePickFor(best)
        end)
        if not ok then
            -- pcall error -> log nh·∫π v√† continue
            warn("Error khi pick:", err)
            goto continue
        end

        if not picked then
            -- n·∫øu th·∫•t b·∫°i, ƒë·ª£i ch√∫t, rescan
            task.wait(0.25)
            goto continue
        end

        -- n·∫øu pick th√†nh c√¥ng, chuy·ªÉn ƒë·∫øn smallest (k√©o v·ªÅ)
        if smallest and smallest.pos then
            local spos = safeGetPosition(smallest.instance)
            if spos then
                pcall(function() player.Character.HumanoidRootPart.CFrame = CFrame.new(spos + Vector3.new(0,3,0)) end)
                task.wait(0.15)
            end
        end

        -- short pause before next cycle
        task.wait(0.2)
    end
end)

-- cleanup on character remove / player leave
player.AncestryChanged:Connect(function()
    running = false
end)
player.OnTeleport = function() running = false end

print("üèÅ AutoFarm script ready. K√©o UI v√† b·∫≠t n√∫t ƒë·ªÉ b·∫Øt ƒë·∫ßu.")
